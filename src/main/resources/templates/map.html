<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Event Map</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        #map {
            width: 100%;
            height: 100%;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <script src="/base.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <div th:replace="fragments/header :: header"></div>

    <main>
        <div id="map">

        </div>
    </main>

    <div th:replace="fragments/footer :: footer"></div>

    <script>
        window.addEventListener("load", () => {
            bootstrapSession({
                onAuthenticated:async()=> {

                },
                onAnonymous:async()=> {

                }
            });

            initMap();
        });

        /////////////////MAP
        let map = null;
        let eventCluster = null;

        async function initMap() {
            if (!map) {

                map = L.map(
                    "map",
                    {worldCopyJump: true, minZoom: 1,maxZoom: 18}
                );

                eventCluster = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    maxClusterRadius: 40, // tweak for density
                    spiderfyOnMaxZoom: true
                });

                map.addLayer(eventCluster);


                map.fitWorld();

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "¬© OpenStreetMap contributors"
                }).addTo(map);

                map.on("click", onMapClick);
                map.on("moveend", scheduleMapEventLoad);

                await applyIpLocation();
                await requestPreciseLocation();
            }
        }

        function wrapLon(lon) {
            // wraps to [-180, 180]
            return ((((lon + 180) % 360) + 360) % 360) - 180;
        }
        function clampLat(lat) {
            return Math.max(-90, Math.min(90, lat));
        }


        let loadTimer = null;
        function scheduleMapEventLoad() {
            if (loadTimer) clearTimeout(loadTimer);

            loadTimer = setTimeout(() => {
                showEventsOnMap();
                loadTimer = null;
            }, 300);
        }

        async function showEventsOnMap() {
            if (!map) return;

            const b = map.getBounds();

            let minLon = wrapLon(b.getWest());
            let maxLon = wrapLon(b.getEast());
            if (minLon > maxLon) {
                const centerLon = wrapLon(map.getCenter().lng);
                let side;
                if (centerLon >= 0) {
                    // eastern hemisphere
                    minLon = Math.max(minLon, 0);
                    maxLon = 180;
                    side = "eastern hemisphere"
                } else {
                    // western hemisphere
                    minLon = -180;
                    maxLon = Math.min(maxLon, 0);
                    side = "western hemisphere"
                }
                notify(
                    "Map crosses the dateline ‚Äî showing events on the "+side+". Zoom in for more.",
                    "info", true
                );
            }

            const bbox = [
                minLon,   // minLon
                clampLat(b.getSouth()),  // minLat
                maxLon,   // maxLon
                clampLat(b.getNorth())   // maxLat
            ].join(",");

            const now = new Date();
            const from = new Date(now.getTime() - 12 * 60 * 60 * 1000);

            const params = new URLSearchParams({
                bbox,
                //from: from.toISOString(),
                orderBy: "termin",
                orderDir: "asc",
                page: "0",
                size: "100"
            });

            let page;
            try {
                page = await api("/events?" + params.toString());
            } catch (e) {
                notify(e);
                return;
            }

            clearMapEventMarkers();

            page.content.forEach(ev => {
                const loc = ev.location;
                if (!loc || loc.latitude == null || loc.longitude == null) return;

                const marker = L.marker([loc.latitude, loc.longitude]);
                marker.bindPopup(renderEventPopup(ev));
                eventCluster.addLayer(marker);
            });

            if (page.totalElements > page.content.length) {
                notify(
                    "Zoom in to see more events in this area",
                    "info", true
                );
            }

            // Optional: fit map to markers
            //if (eventMarkers.length > 0) {
            //    const group = L.featureGroup(eventMarkers);
            //    map.fitBounds(group.getBounds().pad(0.2));
            //}
        }

        function clearMapEventMarkers() {
            if (eventCluster) {
                eventCluster.clearLayers();
            }
        }

        function renderEventPopup(ev) {
            const title = escapeHtml(ev.title || "Untitled");
            const id = ev.id || "";
            const when = ev.termin ? escapeHtml(ev.termin) : "no date";
            const place = ev.location?.displayName
                ? escapeHtml(ev.location.displayName)
                : "";
            const desc = ev.description
                ? escapeHtml(ev.description)
                : "";

            return `
        <b><a href="/event?id=${id}">${title}</a></b><br>
        <small class="timestamp">${when}</small><br>
        ${place ? `üìç ${place}<br>` : ""}
        ${desc ? `<div style="margin-top:6px">${desc}</div>` : ""}
    `;
        }

        async function onMapClick(e){
            //
        }

        async function applyIpLocation() {
            try {
                const loc = await getIpLocation();
                map.setView([loc.lat, loc.lon], 10);
            } catch {
                // silently ignore
            }
        }

        async function requestPreciseLocation() {
            try {
                const loc = await getBrowserLocation();
                map.setView([loc.lat, loc.lon], 14);
            } catch {
                notify("Location access denied", "info", true);
            }
        }



        function getBrowserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject("Geolocation not supported");
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    pos => resolve({
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude
                    }),
                    err => reject(err),
                    {
                        enableHighAccuracy: false,
                        timeout: 8000,
                        maximumAge: 60_000
                    }
                );
            });
        }

        async function getIpLocation() {
            const res = await fetch("https://ipwho.is/");
            const data = await res.json();

            if (!data.success) {
                throw new Error("IP location failed");
            }

            return {
                lat: data.latitude,
                lon: data.longitude,
                city: data.city,
                country: data.country_code
            };
        }

    </script>
</body>
</html>