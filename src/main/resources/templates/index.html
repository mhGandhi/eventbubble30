<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Eventbubble</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .audit.success  { border-left: 4px solid #4caf50; }
        .audit.fail     { border-left: 4px solid #f44336; }
        .audit:hover    { background: #fafafa; }
        .audit          { border-top: 1px solid black; }
        .audit-live-status              { font-weight: bold; }
        .audit-live-status.connected    { color: #2ecc71; /* green */ }
        .audit-live-status.connecting   { color: #f1c40f; /* yellow */ }
        .audit-live-status.error        { color: #e74c3c; /* red */ }
        .audit-live-status.closed       { color: #95a5a6; /* gray */ }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
<script src="/base.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div th:replace="fragments/header :: header"></div>
<main>

<section class="page-width" id="sessionSection">
    <!-- SESSION -->
    <h2>Session</h2>
    <div class="box">
        <button onclick="refreshMeDisplay()">Reload Current User</button>
        <button onclick="logout()">Logout</button>
        <button onclick="logoutEverywhere()">Logout Everywhere</button>
    </div>
</section>

<section class="page-width" id="profileSection">
    <!-- PROFILE -->
    <h2>Me</h2>
    <div class="box">
        <h3>User</h3>
        <div id="me"></div>
    </div>
    <div class="box">
        <h3>Profile</h3>
        <div id="createProfile">
            <h3>Create Profile</h3>
            <input id="newProfileName" placeholder="Name">
            <textarea id="newProfileBio" placeholder="Bio"></textarea>
            <hr>
            <button onclick="createProfile()">Create Profile</button>
            <small id="profileHint" style="display:block;color:#666;"></small>
        </div>
        <div id="updateProfile">
            <div id="avatarBox">
                <img id="avatarImg"
                     src=""
                     alt="avatar"
                     style="max-width:150px; max-height:150px; border-radius:8px;">
            </div>

            <input type="file" id="avatarFile" accept="image/*">
            <button onclick="uploadAvatar()">Upload Avatar</button>
            <button onclick="deleteAvatar()">Delete Avatar</button>

            <hr>
            <div>
                <input type="text" id="profileName">
                <textarea id="profileBio" placeholder="Your bio"></textarea>
            </div>

            <hr>
            <button onclick="updateProfile()">Update</button>
            <button style="background:#e74c3c;color:white"
                    onclick="deleteMyProfile()">
                Delete Profile
            </button>

        </div>
    </div>
</section>

<section class="page-width" id="eventSection">
    <h2>Events</h2>
    <div class="box" id="createEvent">
        <a href="/event">Create Event</a>
    </div>
    <div class="box">
        <h3>All Events</h3>
        <details class="box event-filters">
            <summary>Filters</summary>

            <div class="audit-grid">
                <label>
                    <span>Search</span>
                    <input id="ev_q" placeholder="Title or description">
                </label>

                <label>
                    <span>Owner ID</span>
                    <input id="ev_owner" type="number" placeholder="User ID">
                </label>

                <label>
                    <span>From</span>
                    <input id="ev_from" type="datetime-local">
                </label>

                <label>
                    <span>To</span>
                    <input id="ev_to" type="datetime-local">
                </label>

                <label>
                    <span>Order by</span>
                    <select id="ev_orderBy">
                        <option value="termin">Date</option>
                        <option value="creationDate">Created</option>
                        <option value="modificationDate">Modified</option>
                    </select>
                </label>

                <label>
                    <span>Direction</span>
                    <select id="ev_orderDir">
                        <option value="asc">Asc</option>
                        <option value="desc">Desc</option>
                    </select>
                </label>

                <label class="span-2">
                    <span>Near location</span>

                    <div class="location-box" id="location_event_near" data-location="">
                        <div class="location-summary">
                            <i>No location set</i>
                        </div>

                        <button onclick="editLocation('location_event_near')">
                            Set location
                        </button>
                        <button onclick="clearLocation('location_event_near')">
                            Clear
                        </button>
                    </div>
                </label>

                <label>
                    <span>Radius (km)</span>
                    <input id="ev_near_radius" type="number" step="0.5" min="1" value="5" max="100">
                </label>
            </div>

            <button onclick="applyEventFilters()">Apply Filters</button>
        </details>

        <button onclick="listEvents()">Reload Events</button>
        <div id="events"></div>
        <div class="box" id="eventPagination">
            <button onclick="prevEventPage()">◀ Prev</button>
            <span id="eventPageInfo"></span>
            <button onclick="nextEventPage()">Next ▶</button>
        </div>
    </div>
</section>

<section id="auditSection" class="audit-wrap page-width" style="display:none;">
    <h2>Audit Log</h2>

    <div class="box audit-filters">
        <h3>Filters</h3>

        <div class="audit-grid">
            <label>
                <span>User ID</span>
                <input id="flt_userId" type="number" placeholder="User ID">
            </label>

            <label>
                <span>Success</span>
                <select id="flt_success">
                    <option value="">Any</option>
                    <option value="true">Success</option>
                    <option value="false">Failure</option>
                </select>
            </label>

            <label class="span-2">
                <span>Actions</span>
                <select id="flt_action" multiple size="6">
                    <option value="CREATE">CREATE</option>
                    <option value="READ">READ</option>
                    <option value="UPDATE">UPDATE</option>
                    <option value="DELETE">DELETE</option>
                    <option value="SIGNUP">SIGNUP</option>
                    <option value="LOGIN">LOGIN</option>
                    <option value="REFRESH">REFRESH</option>
                    <option value="INVALIDATE_TOKENS">INVALIDATE_TOKENS</option>
                    <option value="MAIL_REQUEST">MAIL_REQUEST</option>
                    <option value="OTHER">OTHER</option>
                    <option value="CLEANUP_UNVERIFIED_ACCOUNTS">CLEANUP_UNVERIFIED_ACCOUNTS</option>
                </select>
                <small class="hint">Tip: Ctrl/⌘+click to multi-select</small>
            </label>

            <label>
                <span>Resource Type</span>
                <select id="flt_resourceType">
                    <option value="">Any</option>
                    <option>PROFILE</option>
                    <option>USER</option>
                    <option>EVENT</option>
                    <option>SERVER_CONFIG</option>
                </select>
            </label>

            <label>
                <span>Resource ID</span>
                <input id="flt_resourceId" type="number" placeholder="Resource ID">
            </label>
        </div>

        <button class="btn primary" onclick="applyAuditFilters()">Apply Filters</button>
    </div>

    <div class="box audit-live">
        <div class="audit-live-header">
            <h3 class="audit-live-status connecting" id="auditStreamStatus">● connecting</h3>
        </div>
        <div id="auditLog" class="audit-list"></div>
    </div>
</section>

<script>
    // ----------------------
    // START (session check)
    // ----------------------
    window.addEventListener("load", () => {
        bootstrapSession({
            onAuthenticated:async()=> {
                updateAuthUi(true);
                await refreshMeDisplay();
                await listEvents();
                await initAuditLogIfAdmin();
            },
            onAnonymous:async()=> {
                updateAuthUi(false);
                await listEvents();
            }
        });
    });

    // --------------------------
    // AUTH
    // --------------------------
    async function logoutEverywhere() {
        try { await api("/auth/invalidate-tokens", "POST"); } catch (_) {}
        await logout();
    }

    function updateAuthUi(loggedIn) {
        document.getElementById("sessionSection").style.display = loggedIn ? "block" : "none";
        document.getElementById("profileSection").style.display = loggedIn ? "block" : "none";
        document.getElementById("createEvent").style.display = loggedIn ? "block" : "none";
    }

    EventBubbleBus.addEventListener("auth:logout",async () => {
        updateAuthUi(false);
        await initAuditLogIfAdmin();
        await listEvents();
    });

    // --------------------------
    // USER
    // --------------------------
    async function refreshMeDisplay() {
        try {
            const data = await getMe();
            document.getElementById("me").textContent = JSON.stringify(data, null, 2);
            updateAuthUi(true);
        } catch (e) { notify(e); updateAuthUi(true); }

        await loadMyProfileIfExists();
    }
    EventBubbleBus.addEventListener("auth:refreshed", async () => {await refreshMeDisplay();});


    // --------------------------
    // EVENTS
    // --------------------------
    const eventState = {
        page: 0,
        size: 10,
        totalPages: 0
    };

    //LIST
    function buildEventQuery() {
        const params = new URLSearchParams();

        if (ev_q.value.trim())
            params.append("q", ev_q.value.trim());

        if (ev_owner.value)
            params.append("owner", ev_owner.value);

        if (ev_from.value)
            params.append("from", new Date(ev_from.value).toISOString());

        if (ev_to.value)
            params.append("to", new Date(ev_to.value).toISOString());

        // --- NEAR FILTER (using existing location system) ---
        const nearLoc = getLocationFromBox("location_event_near");
        const radius = ev_near_radius.value;

        if (
            nearLoc &&
            nearLoc.latitude != null &&
            nearLoc.longitude != null &&
            radius
        ) {
            params.append(
                "near",
                `${nearLoc.latitude},${nearLoc.longitude},${radius}`
            );
        }

        params.append("orderBy", ev_orderBy.value);
        params.append("orderDir", ev_orderDir.value);
        params.append("page", eventState.page);
        params.append("size", eventState.size);

        return params.toString();
    }

    function applyEventFilters() {
        eventState.page = 0;
        listEvents();
    }

    function nextEventPage() {
        if (eventState.page + 1 >= eventState.totalPages) return;
        eventState.page++;
        listEvents();
    }

    function prevEventPage() {
        if (eventState.page === 0) return;
        eventState.page--;
        listEvents();
    }

    function updateEventPagerButtons() {
        document.querySelector("#eventPagination button:first-child")
            .disabled = eventState.page === 0;

        document.querySelector("#eventPagination button:last-child")
            .disabled = eventState.page + 1 >= eventState.totalPages;
    }

    async function listEvents() {
        try {
            const q = buildEventQuery();
            const page = await api("/events?" + q);

            const ownerCache = new Map();
            async function getOwnerSnippetCached(owner) {
                if (!owner) return "<i>unknown</i>";
                if (!ownerCache.has(owner.id)) {
                    ownerCache.set(owner.id, buildUserSnippet(owner));
                }
                return ownerCache.get(owner.id);
            }

            eventState.totalPages = page.totalPages;

            const out = document.getElementById("events");
            out.innerHTML = "";

            for (const ev of page.content) {
                const ownerSnippet = await getOwnerSnippetCached(ev.besitzer);

                const div = renderEvent(ev, ownerSnippet, null);

                out.appendChild(div);
                setLocationInBox(
                    `location_event_${ev.id}`,
                    ev.location
                );
            }

            document.getElementById("eventPageInfo").textContent =
                `Page ${page.number + 1} / ${page.totalPages}`;
        } catch (e) {
            notify(e);
        }

        updateEventPagerButtons();
    }

    // --------------------------
    // AUDIT LOG (ADMIN ONLY)
    // --------------------------
    let auditEventSource = null;
    async function initAuditLogIfAdmin() {
        const wrapper = document.getElementById("auditSection");
        const me = await getMe();

        if (!me || !me.roles.includes("ADMIN")) {
            wrapper.style.display = "none";

            // Stop existing SSE connection
            if (auditEventSource) {
                auditEventSource.close();
                auditEventSource = null;
            }

            return;
        }

        wrapper.style.display = "block";

        await loadLatestAuditLogs();
        if (!auditEventSource) {
            startAuditStream();
        }
    }

    EventBubbleBus.addEventListener("auth:refreshed", () => {
        if (!auditEventSource) return;      // nothing running
        if (!isAuditVisible()) return;      // not an admin anymore

        restartAuditStream();
    });

    function isAuditVisible() {
        const section = document.getElementById("auditSection");
        return section && section.style.display !== "none";
    }

    async function loadLatestAuditLogs() {
        try {
            const q = buildAuditFilterQuery();
            const url = "/admin/audit-log?page=0&size=15" + (q ? "&" + q : "");

            const resp = await api(url);
            const div = document.getElementById("auditLog");

            div.innerHTML = "";
            resp.content.forEach(entry => {
                div.appendChild(renderAuditEntry(entry));
            });

        } catch (e) {
            console.error(e);
        }
    }

    function restartAuditStream() {
        if (auditEventSource) {
            auditEventSource.close();
            auditEventSource = null;
        }

        startAuditStream();
    }

    function startAuditStream() {
        if (auditEventSource) return;

        const q = buildAuditFilterQuery();
        const url =
            API +
            "/admin/audit-log/stream?accessToken=" +
            encodeURIComponent(accessToken) +
            (q ? "&" + q : "");

        auditEventSource = new EventSource(url);

        auditEventSource.addEventListener("audit-log", event => {
            const entry = JSON.parse(event.data);
            appendAuditEntry(entry);
        });

        auditEventSource.onopen = () => {
            setAuditStatus("connected", "live");
        };

        auditEventSource.onerror = () => {
            console.warn("Audit log stream disconnected. Browser will retry…");
            setAuditStatus("error", "disconnected");
        };
    }

    function appendAuditEntry(entry) {
        const div = document.getElementById("auditLog");

        // Insert at top
        div.prepend(renderAuditEntry(entry));

        // Keep only 5
        while (div.children.length > 15) {
            div.removeChild(div.lastChild);
        }
    }

    function buildAuditFilterQuery() {
        const params = new URLSearchParams();

        if (flt_userId.value)
            params.append("userId", flt_userId.value);

        // MULTI-SELECT ACTIONS
        const selectedActions = Array.from(flt_action.selectedOptions).map(o => o.value);
        selectedActions.forEach(a => params.append("action", a));

        if (flt_resourceType.value)
            params.append("resourceType", flt_resourceType.value);

        if (flt_resourceId.value)
            params.append("resourceId", flt_resourceId.value);

        if (flt_success.value)
            params.append("success", flt_success.value);

        return params.toString();
    }

    function applyAuditFilters() {
        // Close SSE if open
        if (auditEventSource) {
            auditEventSource.close();
            auditEventSource = null;
        }

        loadLatestAuditLogs();
        startAuditStream();
    }

    const statusEl = document.getElementById("auditStreamStatus");
    function setAuditStatus(state, text) {
        statusEl.className = `audit-live-status ${state}`;
        statusEl.textContent = `● ${text}`;
    }

    // --------------------------
    // PROFIL
    // --------------------------
    function renderAvatar(url) {
        const img = document.getElementById("avatarImg");
        if (url) {
            img.src = url + "?t=" + Date.now(); // cache busting
        } else {
            img.src = "https://ui-avatars.com/api/?name=XX";
        }
    }

    async function uploadAvatar() {
        const fileInput = document.getElementById("avatarFile");
        if (!fileInput.files.length) {
            notify("Select a file first", "warn");
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        let res;
        try{
            res = await api("/profiles/me/avatar", "PUT", formData);
        }catch(e){
            notify(e);
            return;
        }

        notify("updated avatar", "success");
        const updatedProfile = await res.json();
        renderAvatar(updatedProfile.avatarURL);
    }

    async function deleteAvatar() {
        if (!confirm("Delete avatar?")) return;

        let res;
        try{
            res = await api("/profiles/me/avatar", "DELETE");
        }catch(e){
            notify(e);
            return;
        }
        notify("Deleted Avatar.", "success");
        const updatedProfile = await res.json();
        renderAvatar(updatedProfile.avatarURL);
    }

    function setProfileUiState(hasProfile) {
        const createBox = document.getElementById("createProfile");
        const updateBox = document.getElementById("updateProfile");

        createBox.style.display = hasProfile ? "none" : "block";
        updateBox.style.display = hasProfile ? "block" : "none";
    }

    async function loadMyProfileIfExists() {
        try {
            const exists = await api("/profiles/me/exists");
            setProfileUiState(!!exists);

            if (!exists) {
                renderAvatar(null);
                document.getElementById("profileHint").textContent =
                    "No profile yet. Create one to upload an avatar.";
                return null;
            }

            const p = await api("/profiles/me");
            document.getElementById("profileName").value = p.name || "";
            document.getElementById("profileBio").value  = p.bio  || "";
            renderAvatar(p.avatarURL || p.avatarUrl); // handle either casing
            document.getElementById("profileHint").textContent = "";
            return p;
        } catch (e) {
            console.error(e);
            // If endpoint missing or backend error, don’t break the whole page
            setProfileUiState(false);
            return null;
        }
    }

    async function createProfile() {
        const name = document.getElementById("newProfileName").value.trim();
        const bio = document.getElementById("newProfileBio").value.trim();

        if (!name) {
            notify("Name is required", "warn");
            return;
        }

        try {
            await api("/profiles/me", "POST", { name, bio });
            await loadMyProfileIfExists();
            notify("Profile created!");
        } catch (e) {
            notify(e);
        }
    }

    async function updateProfile() {
        const name = document.getElementById("profileName").value.trim();
        const bio  = document.getElementById("profileBio").value.trim();

        if (!name) {
            notify("Name is required", "warn");
            return;
        }

        try {
            await api("/profiles/me", "PATCH", { name, bio });
            notify("Profile updated!");
            await loadMyProfileIfExists();
        } catch (e) {
            notify(e);
        }
    }

    async function deleteMyProfile() {
        if (!confirm("This will permanently delete your profile and avatar. Continue?")) {
            return;
        }

        try {
            await api("/profiles/me", "DELETE");
            notify("Profile deleted");

            setProfileUiState(false);
            renderAvatar(null);

            document.getElementById("profileName").value = "";
            document.getElementById("profileBio").value = "";

        } catch (e) {
            notify(e);
        }
    }
</script>
</main>
<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
