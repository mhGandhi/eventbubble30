<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EventBubble Minimal Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 900px;
        }
        h2 { margin-top: 40px; }
        input, button, textarea {
            padding: 6px;
            margin: 4px 0;
            width: 100%;
            max-width: 300px;
        }
        button { cursor: pointer; }
        .box {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .event {
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 5px;
        }
        pre {
            background: #eee;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>

<h1>EventBubble Minimal Frontend</h1>

<div id="statusBox" class="box">
    <b>Session Status:</b>
    <pre id="status">Unknown</pre>
</div>

<!-- LOGIN -->
<h2>Login</h2>
<div class="box">
    <input id="login_user" placeholder="Username">
    <input id="login_pass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
</div>

<!-- SIGNUP -->
<h2>Signup</h2>
<div class="box">
    <input id="signup_user" placeholder="Username">
    <input id="signup_mail" placeholder="Email">
    <input id="signup_pass" type="password" placeholder="Password">
    <button onclick="signup()">Signup</button>
</div>

<!-- SESSION -->
<h2>Session</h2>
<div class="box">
    <button onclick="validateSession()">Validate Session</button>
    <button onclick="getMe()">Load Current User</button>
    <button onclick="logout()">Logout</button>
</div>

<pre id="me"></pre>

<!-- EVENTS -->
<h2>Events</h2>
<div class="box">
    <h3>Create Event</h3>
    <input id="event_title" placeholder="Title">
    <input id="event_date" placeholder="ISO Date (optional)">
    <textarea id="event_desc" placeholder="Description"></textarea>
    <button onclick="createEventVS()">Create Event</button>
</div>

<div class="box">
    <h3>All Events</h3>
    <button onclick="listEvents()">Reload Events</button>
    <div id="events"></div>
</div>

<script>
    const API = "http://localhost:8080/api";
    const json = x => JSON.stringify(x, null, 2);

    async function api(url, method="GET", body=null) {
        const res = await fetch(API + url, {
            method,
            credentials: "include",
            headers: body ? {"Content-Type": "application/json"} : {},
            body: body ? JSON.stringify(body) : null
        });

        if (!res.ok) {
            const t = await res.text();
            throw new Error("HTTP " + res.status + ": " + t);
        }

        const ct = res.headers.get("Content-Type") || "";
        if (ct.includes("application/json")) return res.json();
        return res.text();
    }

    function setStatus(msg){
        document.getElementById("status").textContent = msg;
    }

    async function login() {
        try {
            const username = login_user.value;
            const password = login_pass.value;
            const data = await api("/auth/login", "POST", {username, password});
            setStatus("Logged in as: " + data.username + " ("+data.id+")");
        } catch (e) { alert(e); }
    }

    async function signup() {
        try {
            const body = {
                username: signup_user.value,
                email: signup_mail.value,
                password: signup_pass.value,
                captchaToken: "ABC die Katze tanzt im Schnee"
            };
            const res = await api("/auth/signup", "POST", body);
            alert("Created: " + json(res));
        } catch (e) { alert(e); }
    }

    async function logout() {
        try {
            await api("/auth/logout", "POST");
            setStatus("Logged out.");
        } catch (e) { alert(e); }
    }

    async function validateSession() {
        try {
            await api("/auth/validate-session");
            setStatus("Session VALID");
        } catch (e) {
            setStatus("Session INVALID");
        }
    }

    async function getMe() {
        try {
            const data = await api("/user/me");
            document.getElementById("me").textContent = json(data);
            setStatus("Logged in as: " + data.username + " ("+data.id+")");
        } catch (e) { alert(e); }
    }

    async function createEventVS() {
        try {
            console.log("Creating Event");
            const body = {
                title: event_title.value,
                description: event_desc.value,
                termin: event_date.value || null
            };
            console.log("Created Body");
            const res = await api("/events/create", "POST", body);
            console.log("Called API");
            alert("Event created!");
            await listEvents();
            console.log("Listed Events");
        } catch (e) { alert(e); }
    }

    async function deleteEvent(id) {
        if (!confirm("Delete event " + id + "?")) return;
        try {
            await api("/events/" + id, "DELETE");
            await listEvents();
        } catch (e) { alert(e); }
    }

    async function listEvents() {
        try {
            const page = await api("/events");
            const out = document.getElementById("events");
            out.innerHTML = "";
            page.content.forEach(ev => {
                const div = document.createElement("div");
                div.className = "event";
                div.innerHTML = `
                <b>${ev.title}</b> (ID ${ev.id})<br>
                By: ${ev.besitzer?.username}<br>
                <small>${ev.termin || "no date"}</small><br>
                ${ev.description || ""}<br>
                <button onclick="deleteEvent(${ev.id})">Delete</button>
            `;
                out.appendChild(div);
            });
        } catch (e) { alert(e); }
    }

</script>
</body>
</html>
