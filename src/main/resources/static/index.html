<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EventBubble Minimal Frontend (JWT Version)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 900px;
        }
        h2 { margin-top: 40px; }
        input, button, textarea {
            padding: 6px;
            margin: 4px 0;
            width: 100%;
            max-width: 350px;
        }
        textarea { height: 70px; }
        button { cursor: pointer; }
        .box {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            background: #fafafa;
        }
        .event {
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 5px;
            border-radius: 5px;
            background: #fff;
        }
        pre {
            background: #eee;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>

<h1>EventBubble Minimal Frontend v2</h1>

<!-- STATUS -->
<div id="statusBox" class="box">
    <b>Session Status:</b>
    <pre id="status">Unknown</pre>
</div>

<!-- LOGIN -->
<h2>Login</h2>
<div class="box">
    <input id="login_user" placeholder="Username">
    <input id="login_pass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
</div>
<div class="box">
    <input id="emailToResetPassword" placeholder="Email for pw reset">
    <button onclick="requestPasswordReset()">Request Password Reset</button>
</div>
<div class="box">
    <input id="passwordToken" placeholder="Password Reset Token">
    <input id="newPassword" type="password" placeholder="New Password">
    <button onclick="resetPassword()">Reset Password</button>
</div>

<!-- SIGNUP -->
<h2>Signup</h2>
<div class="box">
    <input id="signup_user" placeholder="Username">
    <input id="signup_mail" placeholder="Email">
    <input id="signup_pass" type="password" placeholder="Password">
    <button onclick="signup()">Signup</button>
</div>

<div class="box">
    <input id="emailToVerify" placeholder="Email to Verify">
    <button onclick="requestEmailVerification()">Request Token</button>
    <input id="emailToken" placeholder="Verification Token">
    <button onclick="verifyEmail()">Verify Token</button>
</div>

<!-- SESSION -->
<h2>Session</h2>
<div class="box">
    <button onclick="validateSession()">Validate Session</button>
    <button onclick="getMe()">Load Current User</button>
    <button onclick="logout()">Logout</button>
</div>

<pre id="me"></pre>

<!-- EVENTS -->
<h2>Events</h2>
<div class="box">
    <h3>Create Event</h3>
    <input id="event_title" placeholder="Title">
    <input id="event_date" type="datetime-local" placeholder="ISO Date (optional)">
    <textarea id="event_desc" placeholder="Description"></textarea>
    <button onclick="createEventVS()">Create Event</button>
</div>

<div class="box">
    <h3>All Events</h3>
    <button onclick="listEvents()">Reload Events</button>
    <div id="events"></div>
</div>

<!-- AUDIT LOG (ADMIN ONLY) -->
<whatever id="auditlogwrapper" style="display:none;">
    <h2>Audit Log</h2>
    <div class="box">
        <h3>Filters</h3>

        <label>User ID:</label>
        <input id="flt_userId" type="number" placeholder="User ID">

        <label>Actions:</label>
        <select id="flt_action" multiple size="6" style="width: 200px;">
            <option value="CREATE">CREATE</option>
            <option value="READ">READ</option>
            <option value="UPDATE">UPDATE</option>
            <option value="DELETE">DELETE</option>
            <option value="LOGIN">LOGIN</option>
            <option value="REFRESH">REFRESH</option>
            <option value="INVALIDATE_TOKENS">INVALIDATE_TOKENS</option>
            <option value="OTHER">OTHER</option>
            <option value="CLEANUP_UNVERIFIED_ACCOUNTS">CLEANUP_UNVERIFIED_ACCOUNTS</option>
        </select>


        <label>Resource Type:</label>
        <select id="flt_resourceType">
            <option value="">Any</option>
            <option>PROFILE</option>
            <option>USER</option>
            <option>EVENT</option>
            <option>SERVER_CONFIG</option>
        </select>

        <label>Resource ID:</label>
        <input id="flt_resourceId" type="number" placeholder="Resource ID">

        <label>Success:</label>
        <select id="flt_success">
            <option value="">Any</option>
            <option value="true">Success</option>
            <option value="false">Failure</option>
        </select>

        <button onclick="applyAuditFilters()">Apply Filters</button>
    </div>
    <div class="box">
        <h3>Live Audit Log (latest 5)</h3>
        <div id="auditLog"></div>
    </div>
</whatever>




<script>
    const API = "http://eventbubble.lennadi.com:8080/api";

    // ----------------------
    // JWT STORAGE
    // ----------------------
    let accessToken = null;
    let refreshToken = localStorage.getItem("refreshToken") || null;

    let auditEventSource = null;

    function saveTokens(access, refresh) {
        accessToken = access;
        refreshToken = refresh;
        if (refresh) localStorage.setItem("refreshToken", refresh);
    }

    function clearTokens() {
        accessToken = null;
        refreshToken = null;
        localStorage.removeItem("refreshToken");
    }

    // ----------------------
    // AUTO SESSION CHECK
    // ----------------------
    window.addEventListener("load", () => {
        if (refreshToken) {
            setStatus("Refresh token found — attempting auto-login...");
            refreshAccessToken().catch(() => setStatus("Not logged in"));
        } else {
            setStatus("Not logged in");
        }

        listEvents();
        initAuditLogIfAdmin();
    });

    // --------------------------
    // F E T C H   W R A P P E R
    // --------------------------
    async function api(url, method = "GET", body = null, retry = true) {
        let headers = {};
        if (accessToken) headers["Authorization"] = "Bearer " + accessToken;
        if (body) headers["Content-Type"] = "application/json";

        const res = await fetch(API + url, {
            method,
            headers,
            body: body ? JSON.stringify(body) : null
        });

        // Unauthorized? Try refresh once
        if (res.status === 401 && retry && refreshToken) {
            try {
                await refreshAccessToken();
                return api(url, method, body, false);
            } catch (_) {
                clearTokens();
            }
        }

        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
        try { return JSON.parse(text); }
        catch { return text; }
    }

    // --------------------------
    // REFRESH TOKEN
    // --------------------------
    async function refreshAccessToken() {
        if (!refreshToken) throw new Error("No refresh token");

        const data = await api("/auth/refresh", "POST", { refreshToken }, false);

        saveTokens(data.accessToken, data.refreshToken);
        setStatus(`Token refreshed as ${data.benutzerDTO?.username || "user"}`);
    }

    function setStatus(msg) {
        document.getElementById("status").textContent = msg;
    }

    // --------------------------
    // AUTH
    // --------------------------
    async function login() {
        try {
            const data = await api("/auth/login", "POST", {
                username: login_user.value,
                password: login_pass.value
            }, false);

            saveTokens(data.accessToken, data.refreshToken);
            setStatus("Logged in as: " + data.benutzerDTO.username);

        } catch (e) { alert(e); }

        await listEvents();
        await initAuditLogIfAdmin();
    }

    async function requestEmailVerification() {
        let data;
        try{
            data = await api("/auth/request-email-verification?email="+emailToVerify.value, "POST", null, false);
            alert("Verification email sent: " + JSON.stringify(data));
        }catch (e) { alert(e); }
    }

    async function verifyEmail() {
        let data;
        try{
            data = await api("/auth/verify-email?token="+emailToken.value, "POST", null, false);
            alert("Password reset email sent: " + JSON.stringify(data));
        }catch (e) { alert(e); }

        alert(data);
    }

    async function requestPasswordReset() {
        let data;
        try{
            data = await api("/auth/request-password-reset?email="+emailToResetPassword.value, "POST", null, false);
        }catch (e) { alert(e); }
    }

    async function resetPassword() {
        let data;
        try{
            const body = {newPassword: newPassword.value, token: passwordToken.value};
            data = await api("/auth/reset-password", "POST", body, false);

        }catch (e) { alert(e); }

        alert(data);
    }

    async function signup() {
        try {
            const body = {
                username: signup_user.value,
                email: signup_mail.value,
                password: signup_pass.value,
                captchaToken: "dummy-test"
            };

            const res = await api("/auth/signup", "POST", body);
            alert("Created: " + JSON.stringify(res, null, 2));
        } catch (e) { alert(e); }
    }

    async function logout() {
        try { await api("/auth/invalidate-tokens", "POST"); } catch (_) {}
        clearTokens();
        setStatus("Logged out");
        await initAuditLogIfAdmin();
    }

    async function validateSession() {
        try {
            await api("/auth/validate");
            setStatus("Session VALID");
        } catch (_) {
            setStatus("Session INVALID");
        }
    }

    // --------------------------
    // USER
    // --------------------------
    async function getMe() {
        try {
            const data = await api("/user/me");
            document.getElementById("me").textContent = JSON.stringify(data, null, 2);
            setStatus("Logged in as: " + data.username);
        } catch (e) { alert(e); }
    }
    async function getMeSilent() {
        try {
            return await api("/user/me");
        } catch {
            return null;
        }
    }


    // --------------------------
    // EVENTS
    // --------------------------
    async function createEventVS() {
        try {
            const body = {
                title: event_title.value.trim(),
                description: event_desc.value.trim(),
                termin: event_date.value ? new Date(event_date.value).toISOString() : null,
                location: null
            };

            await api("/events/create", "POST", body);
            alert("Event created!");
            await listEvents();
        } catch (e) { alert(e); }
    }

    async function deleteEvent(id) {
        if (!confirm("Delete event " + id + "?")) return;
        try {
            await api("/events/" + id, "DELETE");
            await listEvents();
        } catch (e) { alert(e); }
    }

    async function updateEvent(id) {
        if (!confirm("Update event " + id + "?")) return;

        try {
            const body = {
                title: document.getElementById(`title_${id}`).value.trim(),
                description: document.getElementById(`desc_${id}`).value.trim(),
                termin: document.getElementById(`date_${id}`).value
                    ? new Date(document.getElementById(`date_${id}`).value).toISOString()
                    : null
            };

            await api(`/events/${id}`, "PATCH", body);
            alert("Event updated!");
            await listEvents();
        } catch (e) {
            alert(e);
        }
    }


    async function listEvents() {
        try {
            const page = await api("/events");
            const out = document.getElementById("events");
            out.innerHTML = "";

            const me = await getMeSilent();

            page.content.forEach(ev => {
                const div = document.createElement("div");
                div.className = "event";

                const canEdit =
                    me &&
                    (me.roles.includes("ADMIN") || me.id === ev.besitzer?.id);

                if(canEdit) {
                    div.innerHTML = `
                        <label>Title:</label><input id="title_${ev.id}" value="${ev.title}"> (ID ${ev.id})<br>
                        By: ${ev.besitzer?.username}<br>
                        <label>Date:</label><input id="date_${ev.id}" type="datetime-local" value="${ev.termin ? ev.termin.substring(0,16) : ""}"><br>
                        <label>Description:</label><textarea id="desc_${ev.id}">${escapeHtml(ev.description || "")}</textarea><br>
                        <button onClick="deleteEvent(${ev.id})">Delete</button>
                        <button onClick="updateEvent(${ev.id})">Update</button>
                    `;
                } else {
                    div.innerHTML = `
                        <b>${ev.title}</b> (ID ${ev.id})<br>
                        By: ${ev.besitzer?.username}<br>
                        <small>${ev.termin || "no date"}</small><br>
                        ${ev.description || ""}<br>
                    `;
                }
                out.appendChild(div);
            });
        } catch (e) { alert(e); }
    }

    function escapeHtml(str) {
        if (!str) return "";
        return str.replace(/[&<>"']/g, c => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;"
        }[c]));
    }

    // --------------------------
    // AUDIT LOG (ADMIN ONLY)
    // --------------------------

    async function initAuditLogIfAdmin() {
        const wrapper = document.getElementById("auditlogwrapper");
        const me = await getMeSilent();

        if (!me || !me.roles.includes("ADMIN")) {
            wrapper.style.display = "none";

            // Stop existing SSE connection
            if (auditEventSource) {
                auditEventSource.close();
                auditEventSource = null;
            }

            return;
        }

        wrapper.style.display = "block";

        await loadLatestAuditLogs();
        if (!auditEventSource) {
            startAuditStream();
        }
    }

    async function loadLatestAuditLogs() {
        try {
            const q = buildAuditFilterQuery();
            const url = "/admin/audit-log?page=0&size=5" + (q ? "&" + q : "");

            const resp = await api(url);
            const div = document.getElementById("auditLog");

            div.innerHTML = "";
            resp.content.forEach(entry => {
                div.appendChild(renderAuditEntry(entry));
            });

        } catch (e) {
            console.error(e);
        }
    }

    function startAuditStream() {
        if (auditEventSource) return;

        const q = buildAuditFilterQuery();
        const url =
            API +
            "/admin/audit-log/stream?accessToken=" +
            encodeURIComponent(accessToken) +
            (q ? "&" + q : "");

        auditEventSource = new EventSource(url);

        auditEventSource.onmessage = (event) => {
            const entry = JSON.parse(event.data);
            appendAuditEntry(entry);
        };

        auditEventSource.onerror = () => {
            console.warn("Audit log stream disconnected. Browser will retry…");
        };
    }


    function renderAuditEntry(entry) {
        const safePayload = JSON.stringify(entry.payload);
        let userStr = "?";
        if(entry.user){
            let userNameSnap = "";
            if(entry.user?.username !== entry.usernameSnapshot){
                userNameSnap = " (damals "+entry.usernameSnapshot+")"
            }
            userStr = entry.user?.username + userNameSnap;
        }


        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #ddd";
        div.style.margin = "5px 0";
        div.innerHTML = `
        <b>${entry.action}</b>
        <small>(${entry.timestamp})</small> <small>[${entry.id}]</small><br>
        User: ${userStr}<small>@${entry.ipAddress}</small><br>
        Endpoint: ${entry.endpoint}<br>
        Success: ${entry.success}<br>
        Resource: ${entry.resourceType} #${entry.resourceId || "-"}<br>
        Payload: ${safePayload}
    `;
        return div;
    }

    function appendAuditEntry(entry) {
        const div = document.getElementById("auditLog");

        // Insert at top
        div.prepend(renderAuditEntry(entry));

        // Keep only 5
        while (div.children.length > 5) {
            div.removeChild(div.lastChild);
        }
    }

    function buildAuditFilterQuery() {
        const params = new URLSearchParams();

        if (flt_userId.value)
            params.append("userId", flt_userId.value);

        // MULTI-SELECT ACTIONS
        const selectedActions = Array.from(flt_action.selectedOptions).map(o => o.value);
        selectedActions.forEach(a => params.append("action", a));

        if (flt_resourceType.value)
            params.append("resourceType", flt_resourceType.value);

        if (flt_resourceId.value)
            params.append("resourceId", flt_resourceId.value);

        if (flt_success.value)
            params.append("success", flt_success.value);

        return params.toString();
    }


    function applyAuditFilters() {
        // Close SSE if open
        if (auditEventSource) {
            auditEventSource.close();
            auditEventSource = null;
        }

        loadLatestAuditLogs();
        startAuditStream();
    }


</script>
</body>
</html>
